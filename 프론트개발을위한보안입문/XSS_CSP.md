# XSS

XSS(크로스 사이트 스크립팅)는 공격자가 웹 페이지에 악의적인 스크립트를 삽입하여 사용자의 브라우저에서 실행되게 하는 보안 취약점입니다.

## XSS의 종류

- Reflected XSS
  - 정의: 반사형 XSS 공격은 사용자가 제공한 데이터를 웹 애플리케이션 서버가 즉시 에러 메시지, 검색 결과, 또는 다른 응답에 포함하여 반환할 때 발생합니다. 이 유형의 공격은 피해자가 공격자가 조작한 링크를 클릭했을 때 일반적으로 발생합니다.
  - 특징: 공격 스크립트는 사용자의 요청에 의해 반사되어 실행되며, 일반적으로 한 번만 실행됩니다. 사용자가 악의적인 링크를 클릭해야만 공격이 성공합니다.
- Stored XSS
  - 정의: 저장형 XSS 공격은 악의적인 스크립트가 웹 애플리케이션의 서버에 저장된 후, 다른 사용자의 웹 페이지 요청 시 해당 스크립트가 페이지와 함께 전송되어 실행되는 경우에 발생합니다. 예를 들어, 포럼 게시글, 댓글, 사용자 프로필 정보 등에 악의적인 스크립트가 포함될 수 있습니다.
  - 특징: 공격은 지속적으로 영향을 미치며, 악의적인 스크립트가 서버에 저장되기 때문에 한 번 저장되면 여러 사용자에게 영향을 줄 수 있습니다.
- DOM-based XSS
  - 정의: DOM 기반 XSS 공격은 클라이언트 측에서 발생하며, 원래 페이지의 서버 응답은 변경되지 않습니다. 대신, 악의적인 스크립트는 페이지가 로드된 후에 DOM(Document Object Model)을 조작하여 실행됩니다. 이 유형의 공격은 주로 클라이언트 측 JavaScript가 사용자 입력을 적절히 처리하지 않고 페이지의 DOM에 동적으로 추가할 때 발생합니다.
  - 특징: 이 공격은 페이지의 HTML 소스 코드를 변경하지 않고, JavaScript를 통해 클라이언트 측에서 직접 실행됩니다. 페이지 URL의 일부로 전달되는 데이터를 사용하여 발생할 수 있습니다.

## 방어원칙

XSS(크로스 사이트 스크립팅) 공격을 방어하는 기본 원칙 중 하나는 사용자의 입력을 DOM에 직접 삽입하지 않는 것입니다. 사용자 입력을 웹 페이지에 직접적으로 삽입할 때는 해당 입력이 악의적인 스크립트를 포함할 수 있으므로, 이를 그대로 삽입하면 XSS 공격에 취약해질 수 있습니다.

## 예시

### 1. 반사형 XSS (Reflected XSS) 예시

사용자가 웹 애플리케이션의 검색 기능을 사용하여 검색어를 제출하고, 웹 애플리케이션이 사용자의 검색어를 검색 결과 페이지에 그대로 반영하여 보여주는 경우를 가정해봅시다. 공격자는 다음과 같은 악의적인 검색어를 사용할 수 있습니다.

```
<script>alert('XSS');</script>
```

공격자가 위의 스크립트를 포함한 URL을 피해자에게 전송하고, 피해자가 그 링크를 클릭하면 검색 결과 페이지에서 스크립트가 실행되어 경고창이 나타납니다. 이는 반사형 XSS 공격의 전형적인 예입니다.

### 2. 저장형 XSS (Stored or Persistent XSS) 예시

웹 포럼이나 댓글 시스템에서 사용자가 제출한 텍스트를 검증 없이 저장하고, 다른 사용자가 해당 페이지를 방문할 때 저장된 콘텐츠를 그대로 렌더링한다고 가정해봅시다. 공격자가 포럼에 다음과 같은 댓글을 남겼다고 합시다.

```
<script>alert('Stored XSS');</script>
```

이 스크립트가 포함된 댓글이 서버에 저장되고, 다른 사용자가 해당 포럼 페이지를 방문할 때마다 스크립트가 실행되어 경고창이 나타납니다. 이것이 저장형 XSS 공격의 예입니다.

### 3. DOM 기반 XSS (DOM-based XSS) 예시

웹 페이지가 URL의 해시(#) 뒤에 오는 값을 가져와서 페이지의 내용에 동적으로 삽입하는 경우를 생각해봅시다. 예를 들어, 다음과 같은 URL이 있을 때,

```
http://example.com/#<script>alert('DOM XSS');</script>
```

웹 페이지의 JavaScript가 URL의 해시 값을 가져와서 페이지에 직접 삽입한다면, 이 스크립트가 실행되어 경고창이 나타날 것입니다. 이는 DOM을 조작하여 발생하는 XSS 공격의 예입니다.

이러한 XSS 공격을 방지하기 위해서는 사용자 입력을 적절히 이스케이핑하고 검증해야 하며, 콘텐츠 보안 정책(CSP)을 적용하는 것이 좋습니다.

### 사용자 입력을 처리하는 방법

1. Text Node 사용: 사용자 입력을 DOM에 추가할 때는 가능한 Text Node로만 취급하여 삽입해야 합니다. 이 방법은 HTML 태그나 JavaScript 코드가 실행되지 않도록 하여 XSS 공격을 방지합니다. 예를 들어, JavaScript에서는 createTextNode 메서드를 사용하여 사용자 입력을 안전하게 DOM에 추가할 수 있습니다.
2. HTML 인코딩: 사용자 입력을 HTML에 삽입하기 전에 HTML 인코딩을 수행해야 합니다. 이는 <, >, &, "와 같은 문자를 HTML 엔티티로 변환하여, 입력값이 HTML로 해석되지 않도록 방지합니다.
3. 데이터 출력 시 이스케이핑: 사용자 입력을 HTML, JavaScript, URL 등에 삽입하기 전에 적절하게 이스케이핑(Escaping) 처리하는 것이 중요합니다. 이는 프레임워크 또는 라이브러리가 제공하는 이스케이핑 함수를 사용하여 수행할 수 있습니다.
4. 콘텐츠 보안 정책(CSP) 설정: CSP를 사용하여 웹 페이지에서 실행할 수 있는 스크립트의 출처를 제한함으로써, 악의적인 스크립트의 실행을 방지할 수 있습니다. 이는 XSS 공격을 방어하는 추가적인 수단으로 작용합니다.

# Dom기반 XSS

DOM기반 XSS를 원인이 되는 브라우저의 기능은 소스와 싱크로 분류할 수 있다.
DOM 기반 XSS를 발생시키는 원인이 되는 location.hash 문자열과 같은 것을 '소스' 라고 하며,
소스의 문자열에서 자바스크립트를 생성하고 실행하는 것을 '싱크' 라고 한다.

# CSP개요

서버에서 허용되지 않은 js의 실행과 리소스 불러오기 등을 차단하며, 브라우저에서 CSP를 지원한다.
헤더를 응답에 포함해 활성화 할 수 있다.

# Strict CSP

CSP를 적용한 페이지는 HTML내 자바스크립트를 작성하는 인라인 스크립트가 금지된다.
사용하려면 unsafe-inline 키워드를 사용해야 한다.
따라서 안전하게 실행하기 위해 nonce-source와 hash-source라는 CSP 헤더를 사용해야 한다.

### 설정값

Content-Security-Policy:
script-src nonce-tXCHNF14THbBvCj3G0WmQ==' object-src none;'
base-uri 'none';

## nce-source

스크립트 요소에 지정된 랜덤 토큰이 CSP 헤더에 지정된 토큰과 일치하지 않으면 에러를 발생시키는 기능
nonce-source를 사용하려면 CSP헤더를 응답에 포함시켜야 한다.

## hash-source

CSP 헤더에 자바스크립트와 css 코드의 해시값을 지정한다.
HTML, CSs, 자바스크립트로만 구성되고, 서버가 없는 정적사이트는 요청마다 nonce값을 생성할 수는 없지만,
hash-source를 사용하면 안전하게 CSP를 설정할 수 있다.

## strict-dynamic

script 요소를 동적으로 생성하고 싶을때는 strict-dynamic 키워드를 사용한다.
그러나 DOM기반 XS싱크인 inerHTML과 document.write는기능이 제한된다.

# Trusted Types

_TrustedTypes 활성화하기_ : Content-Security-Policy: require-trusted-types-for 'script';

검사되지 않은 문자열을 HTML 에 삽입하는 것을 금지하는 기능. 기본값이 비활성화 상태
policy 함수로 검사된 안전한 타입만 HTML에 삽입할 수 있으므로 문자열을 그대로 반영하려고 하면 에러가 발생한다.

브라우저가 Trusted Types 를 지원하지 않을 수 있으므로 함수 사용이 가능한지 체크를 해야한다. [ 158p ]

# 마무리

- xss는 공격자가 만든 함정에 의해 브라우저에서 공격자의 코드를 실행시키는 공격
- xss는 동일 출처 정책으로는 막을 수 없다.
- xss는 라이브러리,프레임워크, 브라우저의 기능을 사용해서 막을 수 있다.
- CSP는 xss등 인젝션 공격을 막기 위한 브라우저의 기능이다.
- CSP는 강력하지만 웹 애플리케이션이 동작할 때 문제가 생길 수 있으므로 보고서를 모니터링 하면서 적용해야 한다.
